using System.IO;
using System.Net;
using System.Text;

namespace InvoiceXpressDotNet.Extensions
{
    public static class WebRequestHelpers
    {
        public static HttpResponseInfo HttpGet(this string destinationUrl, string data = null)
        {
            return HttpRequest(destinationUrl, "GET", data);
        }

        public static HttpResponseInfo HttpPost(this string destinationUrl, string data = null)
        {
            return HttpRequest(destinationUrl, "POST", data);
        }

        public static HttpResponseInfo HttpPut(this string destinationUrl, string data = null)
        {
            return HttpRequest(destinationUrl, "PUT", data);
        }

        public static HttpResponseInfo HttpDelete(this string destinationUrl, string data = null)
        {
            return HttpRequest(destinationUrl, "DELETE", data);
        }

        private static HttpResponseInfo HttpRequest(this string destinationUrl
            , string httpMethod
            , string data = null
            , string contentType = "application/xml; charset=utf-8")
        {
            var request = (HttpWebRequest) WebRequest.Create(destinationUrl);
            request.Method = httpMethod;
            if (!string.IsNullOrWhiteSpace(data))
            {
                byte[] dataBytes = Encoding.UTF8.GetBytes(data);
                request.ContentType = contentType;
                request.ContentLength = dataBytes.Length;
                Stream requestStream = request.GetRequestStream();
                requestStream.Write(dataBytes, 0, dataBytes.Length);
                requestStream.Close();
            }

            string responseStr;
            HttpStatusCode responseCode;

            try
            {
                using (var response = (HttpWebResponse) request.GetResponse())
                    GetResponse(response, out responseCode, out responseStr);
            }
            catch (WebException ex)
            {
                using (var exResponse = (HttpWebResponse) ex.Response)
                    GetResponse(exResponse, out responseCode, out responseStr);
            }

            return HttpResponseInfo.New(responseCode, responseStr);
        }

        private static void GetResponse(HttpWebResponse response, out HttpStatusCode responseCode,
            out string responseStr)
        {
            responseStr = null;
            responseCode = response.StatusCode;
            using (Stream stream = response.GetResponseStream())
            {
                if (stream == null) return;
                using (var reader = new StreamReader(stream))
                    responseStr = reader.ReadToEnd();
            }
        }
    }
}